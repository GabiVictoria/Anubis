{% extends 'principal/base.html' %}
{% load static %}
{% load i18n %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'principal/lidos.css' %}">
  <script src="{% static 'principal/js/lidos.js' %}"></script>
{% endblock %}

{% block content %}
  <div class="card-central">
    <div class="clube-header">
      <img src="{% static 'img/Logo..png' %}" alt="{% trans 'Logo do Clube' %}">
      <h1 class="quebra-linha"> {{ clube.nome }}</h1>
    </div>

    <p class="descricao-clube">
      {{ clube.descricao }}
    </p>

    
    <div class="botoes">
      <a href="{% url 'principal:estante' clube.id %}" class="botoes">{% trans "Lendo" %}</a>
      <a href="{% url 'principal:lidos' clube.id %}" class="botoes">{% trans "Lidos" %}</a>
      <a href="{% url 'principal:abandonados' clube.id %}" class="botoes">{% trans "Abandonados" %}</a>
      <a href="{% url 'principal:proximo_livro' clube.id %}" class="botoes">{% trans "Próximo Livro" %}</a>
      <a href="{% url 'principal:queremos_ler' clube.id %}" class="botoes" id="bt_atual">{% trans "Queremos Ler" %}</a>
      <a href="{% url 'principal:releitura' clube.id %}" class="botoes">{% trans "Releitura" %}</a>
    </div>

   
    <div class="filtro-ano">
      <label for="ano">{% trans "Filtrar por ano:" %} </label>
      <select id="ano">
        <option>{% trans "Todos" %}</option>
        <option>2025</option>
        <option>2024</option>
      </select>
    </div>

    
    <div class="livros-container">
      {% for leitura in leituras_a_ler %}
        <div class="livro-card" data-livro-id="{{ leitura.id }}">
          <img src="{% if leitura.livro.capa %}{{ leitura.livro.capa.url }}{% else %}{% static 'img/default_book_cover.png' %}{% endif %}" alt="{% trans 'Capa do Livro' %}">
          
          <div class="livro-info">
            <h3>{{ leitura.livro.nome }}</h3>
            <p><strong>{% trans "Autor:" %}</strong> {{ leitura.livro.autor }}</p>
            <p><strong>{% trans "Início Previsto:" %}</strong> {% trans "sem data prevista" %}</p>
            <p><strong>{% trans "Nota média:" %}</strong> {% trans "A definir" %}</p>
          </div>
        </div>
      {% empty %}
        <p class="sem-livros-msg" style="width: 100%; text-align: center;">
          {% trans "Ainda não há livros na lista de 'Queremos Ler' deste clube." %}
        </p>
      {% endfor %}
    </div>
  </div>

  
  <div class="modal-overlay" id="statusModalOverlay" style="display:none;">
    <div class="modal" id="statusModal">
      <button class="modal-close" id="modalClose">&times;</button>
      <h2>Alterar Status do Livro</h2>

      <form id="statusForm">
        {% csrf_token %}
        <input type="hidden" id="modalLivroId" name="livro_id" value="">
        
        <label for="novoStatus">Status:</label>
        <select id="novoStatus" name="status">
          <option value="A_LER">{% trans "Queremos Ler" %}</option>
          <option value="PROXIMO">{% trans "Próximo a Ser Lido" %}</option>
          <option value="LENDO">{% trans "Lendo Atualmente" %}</option>
          <option value="FINALIZADO">{% trans "Finalizado" %}</option>
        </select>

        <div class="modal-actions" style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" class="btn-cancel" id="cancelModal">{% trans "Cancelar" %}</button>
          <button type="submit" class="btn-save">{% trans "Salvar" %}</button>
        </div>
      </form>
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalOverlay = document.getElementById('statusModalOverlay');
    const modalClose = document.getElementById('modalClose');
    const cancelModal = document.getElementById('cancelModal');
    const statusForm = document.getElementById('statusForm');
    const modalLivroIdInput = document.getElementById('modalLivroId');
    const clubeId = "{{ clube.id }}"; 

    
    document.querySelectorAll('.livro-card').forEach(card => {
      card.addEventListener('click', () => {
        const leituraId = card.getAttribute('data-livro-id');
        modalLivroIdInput.value = leituraId;
        modalOverlay.style.display = 'flex';
      });
    });

    
    modalClose.addEventListener('click', () => modalOverlay.style.display = 'none');
    cancelModal.addEventListener('click', () => modalOverlay.style.display = 'none');

    
    statusForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const leituraId = modalLivroIdInput.value;
      const novoStatus = document.getElementById('novoStatus').value;

      
      const url = `/app/clube/${clubeId}/admin/alterar-status-leitura/${leituraId}/`;

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({ status: novoStatus }) 
        });

        const data = await response.json();

        if (response.ok) {
          alert('{% trans "Status atualizado com sucesso!" %}');
          modalOverlay.style.display = 'none';
          location.reload(); 
        } else {
          
          alert('{% trans "Erro ao atualizar status:" %} ' + (data.error || ''));
        }
      } catch (error) {
        console.error('Erro na requisição:', error);
        alert('{% trans "Ocorreu um erro de rede. Tente novamente." %}');
      }
    });
  });
</script>
{% endblock %}
