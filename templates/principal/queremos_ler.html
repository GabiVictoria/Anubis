{% extends 'principal/base.html' %}
{% load static %}
{% load i18n %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'principal/lidos.css' %}">
  <script src="{% static 'principal/js/lidos.js' %}"></script>
{% endblock %}

{% block content %}
  <div class="card-central">
    <div class="clube-header">
      <img src="{% static 'img/Logo..png' %}" alt="{% trans 'Logo do Clube' %}">
      <h1 class="quebra-linha"> {{ clube.nome }}</h1>
    </div>

    <p class="descricao-clube">
      {{ clube.descricao }}
    </p>

    
    <div class="botoes">
      <a href="{% url 'principal:estante' clube.id %}" class="botoes">{% trans "Lendo" %}</a>
      <a href="{% url 'principal:lidos' clube.id %}" class="botoes">{% trans "Lidos" %}</a>
      <a href="{% url 'principal:abandonados' clube.id %}" class="botoes">{% trans "Abandonados" %}</a>
      <a href="{% url 'principal:queremos_ler' clube.id %}" class="botoes" id="bt_atual">{% trans "Queremos Ler" %}</a>
    </div>

   
    <div class="filtro-ano">
      <label for="ano">{% trans "Filtrar por ano:" %} </label>
      <select id="ano">
        <option>{% trans "Todos" %}</option>
        <option>2025</option>
        <option>2024</option>
      </select>
    </div>

    
    <div class="livros-container">
      {% for leitura in leituras_a_ler %}
        <div class="livro-card" data-livro-id="{{ leitura.id }}">
          <img src="{% if leitura.livro.capa %}{{ leitura.livro.capa.url }}{% else %}{% static 'img/default_book_cover.png' %}{% endif %}" alt="{% trans 'Capa do Livro' %}">
          
          <div class="livro-info">
            <h3>{{ leitura.livro.nome }}</h3>
            <p><strong>{% trans "Autor:" %}</strong> {{ leitura.livro.autor }}</p>
          </div>
        </div>
      {% empty %}
        <p class="sem-livros-msg" style="width: 100%; text-align: center;">
          {% trans "Ainda não há livros na lista de desejos deste clube." %}
        </p>
      {% endfor %}
    </div>
  </div>

  
  <div class="modal-overlay" id="statusModalOverlay" style="display:none;">
    <div class="modal" id="statusModal">
      <button class="modal-close" id="modalClose">&times;</button>
      <h2>{% trans "Alterar Status do Livro" %}</h2>

      <form id="statusForm">
        {% csrf_token %}
        <input type="hidden" id="modalLivroId" name="livro_id" value="">
        
        <label for="novoStatus">Status:</label>
        <select id="novoStatus" name="status">

          <option value="LENDO_ATUALMENTE">{% trans "Lendo Atualmente" %}</option>
          <option value="FINALIZADO">{% trans "Finalizado" %}</option>
          <option value="ABANDONADO">{% trans "Abandonado" %}</option>
        </select>

        <div id="dataFinalizacaoContainer" style="display:none; margin-top: 10px;">
            <label for="dataFinalizacao">{% trans "Data de Finalização:" %}</label>
            <input type="date" id="dataFinalizacao" name="data_finalizacao" style="width: 100%; padding: 8px; box-sizing: border-box;">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelModal">{% trans "Cancelar" %}</button>
          <button type="submit" class="btn-save">{% trans "Salvar" %}</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
 
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modalOverlay = document.getElementById('statusModalOverlay');
      const modalClose = document.getElementById('modalClose');
      const cancelModal = document.getElementById('cancelModal');
      const statusForm = document.getElementById('statusForm');
      const modalLivroIdInput = document.getElementById('modalLivroId');
      const clubeId = "{{ clube.id }}";
      
      const novoStatusSelect = document.getElementById('novoStatus');
      const dataFinalizacaoContainer = document.getElementById('dataFinalizacaoContainer');

      
      novoStatusSelect.addEventListener('change', () => {
        if (novoStatusSelect.value === 'FINALIZADO') {
          dataFinalizacaoContainer.style.display = 'block';
        } else {
          dataFinalizacaoContainer.style.display = 'none';
        }
      });

      
      document.querySelectorAll('.livro-card').forEach(card => {
        card.addEventListener('click', () => {
          modalLivroIdInput.value = card.getAttribute('data-livro-id');
          
          novoStatusSelect.value = 'A_LER';
          dataFinalizacaoContainer.style.display = 'none';
          modalOverlay.style.display = 'flex';
        });
      });
      
      
      modalClose.addEventListener('click', () => modalOverlay.style.display = 'none');
      cancelModal.addEventListener('click', () => modalOverlay.style.display = 'none');

      
      function showDynamicMessage(message, level) {
          const messagesContainer = document.getElementById('dynamic-messages');
          const messageLi = document.createElement('li');
          messageLi.className = level; 
          messageLi.textContent = message;
          messagesContainer.appendChild(messageLi);
         
          setTimeout(() => {
              messageLi.style.opacity = '0';
              setTimeout(() => messageLi.remove(), 500);
          }, 5000);
      }

      
      statusForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const leituraId = modalLivroIdInput.value;
        const novoStatus = novoStatusSelect.value;
        const dataFinalizacao = document.getElementById('dataFinalizacao').value;
        const url = `/app/clube/${clubeId}/admin/alterar-status-leitura/${leituraId}/`;

        
        let bodyData = { status: novoStatus };
        if (novoStatus === 'FINALIZADO') {
            bodyData.data_finalizacao = dataFinalizacao;
        }

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(bodyData)
          });
          const data = await response.json();

          
          showDynamicMessage(data.message, data.level);

          if (response.ok) {
            modalOverlay.style.display = 'none';
           
            setTimeout(() => location.reload(), 1000);
          }
        } catch (error) {
          console.error('Erro na requisição:', error);
          showDynamicMessage('{% trans "Ocorreu um erro de rede. Tente novamente." %}', 'error');
        }
      });
    });
  </script>
{% endblock %}