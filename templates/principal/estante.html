{% extends 'principal/base.html' %}
{% load static %}
{% load i18n %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'principal/estante.css' %}">
  <link rel="stylesheet" href="{% static 'inicial/messages.css' %}"/>
{% endblock %}

{% block content %}
  <ul class="messages" id="dynamic-messages"></ul>

  <div class="card-central">
    <div class="clube-header">
      <img src="{% static 'img/Logo..png' %}" alt="{% trans 'Logo do Clube' %}">
      <h1 class="quebra-linha">{{ clube.nome }}</h1>
    </div>
    <p class="descricao-clube">{{ clube.descricao }}</p>

    <div class="botoes">
      <a href="{% url 'principal:estante' clube.id %}" class="botoes" id="bt_lendo">{% trans "Lendo" %}</a>
      <a href="{% url 'principal:lidos' clube.id %}" class="botoes">{% trans "Lidos" %}</a>
      <a href="{% url 'principal:abandonados' clube.id %}" class="botoes">{% trans "Abandonados" %}</a>
      <a href="{% url 'principal:queremos_ler' clube.id %}" class="botoes">{% trans "Queremos Ler" %}</a>
    </div>

    <div class="estante-container">
      {% if leitura_atual %}
        <div class="estante-grid-single">
          <div class="livro-card" data-livro-id="{{ leitura_atual.id }}">
            <img src="{% if leitura_atual.livro.capa %}{{ leitura_atual.livro.capa.url }}{% else %}{% static 'img/sem_capa.png' %}{% endif %}" alt="Capa do livro" class="livro-img" />
            <div class="livro-info">
              <h3><span>{{ leitura_atual.livro.nome }}</span></h3>
              <p><strong>{% trans "Autor:" %}</strong> {{ leitura_atual.livro.autor }}</p>
            </div>
          </div>
        </div>
      {% else %}
        <div class="livro-card">
          <h2 class="quebra-linha">{% blocktrans with clube_nome=clube.nome %}O clube '{{ clube_nome }}' não tem uma leitura definida como "lendo atualmente".{% endblocktrans %}</h2>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="modal-overlay" id="statusModalOverlay" style="display:none;">
    <div class="modal" id="statusModal">
      <button class="modal-close" id="modalClose">&times;</button>
      <h2>{% trans "Alterar Status do Livro" %}</h2>
      <form id="statusForm">
        {% csrf_token %}
        <input type="hidden" id="modalLivroId" name="livro_id" value="">
        <label for="novoStatus">Status:</label>
        <select id="novoStatus" name="status">
          <option value="A_LER">{% trans "A Ler" %}</option>

          <option value="FINALIZADO">{% trans "Finalizado" %}</option>
          <option value="ABANDONADO">{% trans "Abandonado" %}</option>
        </select>
        <div id="dataFinalizacaoContainer" style="display:none; margin-top: 10px;">
            <label for="dataFinalizacao">{% trans "Data de Finalização:" %}</label>
            <input type="date" id="dataFinalizacao" name="data_finalizacao">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelModal">{% trans "Cancelar" %}</button>
          <button type="submit" class="btn-save">{% trans "Salvar" %}</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  
 <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modalOverlay = document.getElementById('statusModalOverlay');
      const modalClose = document.getElementById('modalClose');
      const cancelModal = document.getElementById('cancelModal');
      const statusForm = document.getElementById('statusForm');
      const modalLivroIdInput = document.getElementById('modalLivroId');
      const clubeId = "{{ clube.id }}";
      
      const novoStatusSelect = document.getElementById('novoStatus');
      const dataFinalizacaoContainer = document.getElementById('dataFinalizacaoContainer');

      // --- MUDANÇA: Lógica para mostrar/esconder o campo de data ---
      novoStatusSelect.addEventListener('change', () => {
        if (novoStatusSelect.value === 'FINALIZADO') {
          dataFinalizacaoContainer.style.display = 'block';
        } else {
          dataFinalizacaoContainer.style.display = 'none';
        }
      });

      // Abre o modal
      document.querySelectorAll('.livro-card').forEach(card => {
        card.addEventListener('click', () => {
          modalLivroIdInput.value = card.getAttribute('data-livro-id');
          // Reseta o formulário ao abrir
          novoStatusSelect.value = 'A_LER';
          dataFinalizacaoContainer.style.display = 'none';
          modalOverlay.style.display = 'flex';
        });
      });
      
      // Fecha o modal
      modalClose.addEventListener('click', () => modalOverlay.style.display = 'none');
      cancelModal.addEventListener('click', () => modalOverlay.style.display = 'none');

      // --- MUDANÇA: Função para exibir mensagens dinamicamente ---
      function showDynamicMessage(message, level) {
          const messagesContainer = document.getElementById('dynamic-messages');
          const messageLi = document.createElement('li');
          messageLi.className = level; // 'success' ou 'error'
          messageLi.textContent = message;
          messagesContainer.appendChild(messageLi);
          // Adiciona um timer para remover a mensagem após 5 segundos
          setTimeout(() => {
              messageLi.style.opacity = '0';
              setTimeout(() => messageLi.remove(), 500);
          }, 5000);
      }

      // Envia o formulário
      statusForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const leituraId = modalLivroIdInput.value;
        const novoStatus = novoStatusSelect.value;
        const dataFinalizacao = document.getElementById('dataFinalizacao').value;
        const url = `/app/clube/${clubeId}/admin/alterar-status-leitura/${leituraId}/`;

        // --- MUDANÇA: Corpo do JSON agora inclui a data ---
        let bodyData = { status: novoStatus };
        if (novoStatus === 'FINALIZADO') {
            bodyData.data_finalizacao = dataFinalizacao;
        }

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(bodyData)
          });
          const data = await response.json();

          // --- MUDANÇA: Usa a nova função de mensagem em vez de alert() ---
          showDynamicMessage(data.message, data.level);

          if (response.ok) {
            modalOverlay.style.display = 'none';
            // Recarrega a página após um pequeno delay para a mensagem ser lida
            setTimeout(() => location.reload(), 1000);
          }
        } catch (error) {
          console.error('Erro na requisição:', error);
          showDynamicMessage('{% trans "Ocorreu um erro de rede. Tente novamente." %}', 'error');
        }
      });
    });
  </script>
{% endblock %}