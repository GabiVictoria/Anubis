{% extends 'principal/base.html' %}
{% load static %}
{% load i18n %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'principal/estante.css' %}">

{% endblock %}

{% block content %}


  <div class="card-central">
    <div class="clube-header">
      {% if clube.capa_clube %}
        <img src="{{ clube.capa_clube.url }}" alt="{{ clube.nome }}" class="club-main-image">
      {% elif clube.capa_recomendada %}
        <img src="{% static clube.capa_recomendada %}" alt="{{ clube.nome }}" class="club-main-image">
      {% else %}
        <img src="{% static 'img/imgideal.png' %}" alt="{% trans 'Capa Padrão' %}" class="club-main-image">
      {% endif %}
      <h1 class="quebra-linha">{{ clube.nome }}</h1>
    </div>
    <p class="descricao-clube">{{ clube.descricao }}</p>

    <div class="botoes">
      <a href="{% url 'principal:estante' clube.id %}" class="botoes" id="bt_lendo">{% trans "Lendo" %}</a>
      <a href="{% url 'principal:lidos' clube.id %}" class="botoes">{% trans "Lidos" %}</a>
      <a href="{% url 'principal:abandonados' clube.id %}" class="botoes">{% trans "Abandonados" %}</a>
      <a href="{% url 'principal:queremos_ler' clube.id %}" class="botoes">{% trans "Queremos Ler" %}</a>
      <a href="{% url 'principal:detalhes_clube' clube.id %}" class="botoes">{% trans "Voltar ao clube" %}</a>
    </div>

    <div class="estante-container">
      {% if leitura_atual %}
        <div class="estante-grid-single">
          <div class="livro-card" data-livro-id="{{ leitura_atual.id }}">
            <img src="{% if leitura_atual.livro.capa %}{{ leitura_atual.livro.capa.url }}{% else %}{% static 'img/sem_capa.png' %}{% endif %}" alt="Capa do livro" class="livro-img" />
            <div class="livro-info">
              <h3><span>{{ leitura_atual.livro.nome }}</span></h3>
              <p><strong>{% trans "Autor:" %}</strong> {{ leitura_atual.livro.autor }}</p>
            </div>
          </div>
        </div>
      {% else %}
        <div class="livro-card">
          <h2 class="quebra-linha">{% blocktrans with clube_nome=clube.nome %}O clube '{{ clube_nome }}' não tem uma leitura definida como "lendo atualmente".{% endblocktrans %}</h2>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="modal-overlay" id="statusModalOverlay" style="display:none;">
    <div class="modal" id="statusModal">
      <button class="modal-close" id="modalClose">&times;</button>
      <h2>{% trans "Alterar Status do Livro" %}</h2>
      <form id="statusForm">
        {% csrf_token %}
        <input type="hidden" id="modalLivroId" name="livro_id" value="">
        <label for="novoStatus">Status:</label>
        <select id="novoStatus" name="status">
          <option value="A_LER">{% trans "A Ler" %}</option>
          <option value="FINALIZADO">{% trans "Finalizado" %}</option>
          <option value="ABANDONADO">{% trans "Abandonado" %}</option>
        </select>
        <div id="dataFinalizacaoContainer" style="display:none; margin-top: 10px;">
            <label for="dataFinalizacao">{% trans "Data de Finalização:" %}</label>
            <input type="date" id="dataFinalizacao" name="data_finalizacao">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelModal">{% trans "Cancelar" %}</button>
          <button type="submit" class="btn-save">{% trans "Salvar" %}</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  
 <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modalOverlay = document.getElementById('statusModalOverlay');
      const modalClose = document.getElementById('modalClose');
      const cancelModal = document.getElementById('cancelModal');
      const statusForm = document.getElementById('statusForm');
      const modalLivroIdInput = document.getElementById('modalLivroId');
      const clubeId = "{{ clube.id }}";
      
      const novoStatusSelect = document.getElementById('novoStatus');
      const dataFinalizacaoContainer = document.getElementById('dataFinalizacaoContainer');

      // --- MUDANÇA: Lógica para mostrar/esconder o campo de data ---
      novoStatusSelect.addEventListener('change', () => {
        if (novoStatusSelect.value === 'FINALIZADO') {
          dataFinalizacaoContainer.style.display = 'block';
        } else {
          dataFinalizacaoContainer.style.display = 'none';
        }
      });

      // Abre o modal
      document.querySelectorAll('.livro-card').forEach(card => {
        card.addEventListener('click', () => {
          modalLivroIdInput.value = card.getAttribute('data-livro-id');
          // Reseta o formulário ao abrir
          novoStatusSelect.value = 'none';
          dataFinalizacaoContainer.style.display = 'none';
          modalOverlay.style.display = 'flex';
        });
      });
      
      // Fecha o modal
      modalClose.addEventListener('click', () => modalOverlay.style.display = 'none');
      cancelModal.addEventListener('click', () => modalOverlay.style.display = 'none');

     // Função para exibir mensagens dinâmicas (VERSÃO FINAL E ROBUSTA)
    function showDynamicMessage(message, level) {
        
        // 1. Tenta encontrar o container que o 'base.html' cria
        let messagesContainer = document.querySelector('.messages');

        // 2. Se o 'base.html' não criou (por não ter msg do Django), NÓS CRIAMOS.
        if (!messagesContainer) {
            messagesContainer = document.createElement('ul');
            messagesContainer.className = 'messages'; 
            // Insere no topo do body, logo após o <header>
            const header = document.querySelector('header');
            if (header) {
                header.parentNode.insertBefore(messagesContainer, header.nextSibling);
            } else {
                document.body.prepend(messagesContainer); // Fallback
            }
        }

        // 3. Cria e adiciona a mensagem
        const messageLi = document.createElement('li');
        messageLi.className = level; // 'success' ou 'error'
        messageLi.textContent = message;
        messagesContainer.appendChild(messageLi);
        
        // 4. Define o tempo para remover
        setTimeout(() => {
            messageLi.style.opacity = '0';
            setTimeout(() => messageLi.remove(), 500);
        }, 5000);
    }

      // Envia o formulário
  statusForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const leituraId = modalLivroIdInput.value;
        const novoStatus = novoStatusSelect.value;
        const dataFinalizacao = document.getElementById('dataFinalizacao').value;
        // Certifique-se que a URL está correta para a view que altera o status
        const url = `/app/clube/{{ clube.id }}/admin/alterar-status-leitura/${leituraId}/`;

        let bodyData = { status: novoStatus };
        if (novoStatus === 'FINALIZADO') {
            // Validação simples de data no front-end (opcional, mas recomendada)
            if (!dataFinalizacao) {
                showDynamicMessage('{% trans "Por favor, informe a data de finalização." %}', 'error');
                return; // Impede o envio se a data for obrigatória e não preenchida
            }
            bodyData.data_finalizacao = dataFinalizacao;
        }

        // Desabilitar botão para evitar cliques múltiplos (opcional)
        const submitButton = statusForm.querySelector('button[type="submit"]');
        if (submitButton) submitButton.disabled = true;

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(bodyData)
          });

          // Primeiro, verifica se a resposta HTTP indica um erro grave (ex: 403, 404, 500)
          if (!response.ok) {
              // Tenta ler a mensagem de erro do JSON, se houver
              let errorMessage = '{% trans "Ocorreu um erro no servidor." %}';
              try {
                  const errorData = await response.json();
                  errorMessage = errorData.message || errorMessage;
              } catch (jsonError) {
                  // Se não conseguir ler o JSON, usa o status text
                  errorMessage = response.statusText || errorMessage;
              }
              throw new Error(errorMessage); // Joga o erro para o catch
          }

          // Se a resposta HTTP foi OK (2xx), processa o JSON
          const data = await response.json();
          showDynamicMessage(data.message, data.level); // Mostra a mensagem (success ou error lógico)

          // --- PONTO CHAVE DA CORREÇÃO ---
          // Verifica se a operação no backend foi realmente bem-sucedida
          if (data.success) {
            modalOverlay.style.display = 'none'; // Fecha o modal
            // Recarrega a página após a mensagem ser exibida
            setTimeout(() => location.reload(), 1500); // Aumentei um pouco o tempo
          }
          // Se data.success for false, a mensagem de erro já foi exibida,
          // o modal permanece aberto para o usuário corrigir.

        } catch (error) {
          console.error('Erro na requisição ou processamento:', error);
          // Mostra a mensagem de erro capturada (do throw new Error ou erro de rede)
          showDynamicMessage(error.message || '{% trans "Ocorreu um erro de rede. Tente novamente." %}', 'error');
        } finally {
            // Reabilita o botão, independentemente do resultado
            if (submitButton) submitButton.disabled = false;
        }
      });
    });
  </script>
{% endblock %}