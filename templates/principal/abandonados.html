{% extends 'principal/base.html' %}
{% load static %}
{% load i18n %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'principal/lidos.css' %}">
  
{% endblock %}

{% block content %}
  <div class="card-central">
    <div class="clube-header">
      {% if clube.capa_clube %}
        <img src="{{ clube.capa_clube.url }}" alt="{{ clube.nome }}" class="club-main-image">
      {% elif clube.capa_recomendada %}
        <img src="{% static clube.capa_recomendada %}" alt="{{ clube.nome }}" class="club-main-image">
      {% else %}
        <img src="{% static 'img/imgideal.png' %}" alt="{% trans 'Capa Padr칚o' %}" class="club-main-image">
      {% endif %}
      <h1 class="quebra-linha"> {{ clube.nome }}</h1>
    </div>

    <p class="descricao-clube">
      {{ clube.descricao }}
    </p>

    
    <div class="botoes">
      <a href="{% url 'principal:estante' clube.id %}" class="botoes">{% trans "Lendo" %}</a>
      <a href="{% url 'principal:lidos' clube.id %}" class="botoes">{% trans "Lidos" %}</a>
      <a href="{% url 'principal:abandonados' clube.id %}" class="botoes"  id="bt_atual">{% trans "Abandonados" %}</a>
      <a href="{% url 'principal:queremos_ler' clube.id %}" class="botoes">{% trans "Queremos Ler" %}</a>
      <a href="{% url 'principal:detalhes_clube' clube.id %}" class="botoes">{% trans "Voltar ao clube" %}</a>
    </div>

   

    
<div class="livros-container">
      {% for leitura in abandonado %}
        <div class="livro-card" data-livro-id="{{ leitura.id }}">
          <img src="{% if leitura.livro.capa %}{{ leitura.livro.capa.url }}{% else %}{% static 'img/default_book_cover.png' %}{% endif %}" alt="{% trans 'Capa do Livro' %}">
          
          <div class="livro-info">
            <h3>{{ leitura.livro.nome }}</h3>
            <p><strong>{% trans "Autor:" %}</strong> {{ leitura.livro.autor }}</p>
            <p><strong>{% trans "P치ginas" %}</strong> {{leitura.livro.paginas}}</p>
            
          </div>
        </div>
      {% empty %}
        <p class="sem-livros-msg" style="width: 100%; text-align: center;">
          {% trans "Nenhum livro foi abandonado por este clube ainda." %}
        </p>
      {% endfor %}
    </div>
  </div>

  
  <div class="modal-overlay" id="statusModalOverlay" style="display:none;">
    <div class="modal" id="statusModal">
      <button class="modal-close" id="modalClose">&times;</button>
      <h2>{% trans "Alterar Status do Livro" %}</h2>

      <form id="statusForm">
        {% csrf_token %}
        <input type="hidden" id="modalLivroId" name="livro_id" value="">
        
        <label for="novoStatus">Status:</label>
        <select id="novoStatus" name="status">

          <option value="LENDO">{% trans "Lendo Atualmente" %}</option>
          <option value="FINALIZADO">{% trans "Finalizado" %}</option>
          <option value="A_LER">{% trans "Queremos Ler" %}</option>
        </select>

        <div id="dataFinalizacaoContainer" style="display:none; margin-top: 10px;">
            <label for="dataFinalizacao">{% trans "Data de Finaliza칞칚o:" %}</label>
            <input type="date" id="dataFinalizacao" name="data_finalizacao" style="width: 100%; padding: 8px; box-sizing: border-box;">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelModal">{% trans "Cancelar" %}</button>
          <button type="submit" class="btn-save">{% trans "Salvar" %}</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalOverlay = document.getElementById('statusModalOverlay');
    const modalClose = document.getElementById('modalClose');
    const cancelModal = document.getElementById('cancelModal');
    const statusForm = document.getElementById('statusForm');
    const modalLivroIdInput = document.getElementById('modalLivroId');
    const clubeId = "{{ clube.id }}";
    const novoStatusSelect = document.getElementById('novoStatus');
    const dataFinalizacaoContainer = document.getElementById('dataFinalizacaoContainer');
    const dataFinalizacaoInput = document.getElementById('dataFinalizacao');

    // --- 游 Trava de data (impede datas futuras) ---
    const hoje = new Date().toISOString().split('T')[0];
    dataFinalizacaoInput.setAttribute('max', hoje);

    // Exibe o campo de data apenas se for "FINALIZADO"
    novoStatusSelect.addEventListener('change', () => {
      if (novoStatusSelect.value === 'FINALIZADO') {
        dataFinalizacaoContainer.style.display = 'block';
      } else {
        dataFinalizacaoContainer.style.display = 'none';
      }
    });

    // Abre o modal ao clicar em um livro
    document.querySelectorAll('.livro-card').forEach(card => {
      card.addEventListener('click', () => {
        modalLivroIdInput.value = card.getAttribute('data-livro-id');
        novoStatusSelect.value = 'none';
        dataFinalizacaoContainer.style.display = 'none';
        dataFinalizacaoInput.value = ''; // limpa campo anterior
        modalOverlay.style.display = 'flex';
      });
    });

    // Fecha o modal
    modalClose.addEventListener('click', () => modalOverlay.style.display = 'none');
    cancelModal.addEventListener('click', () => modalOverlay.style.display = 'none');

// Fun칞칚o para exibir mensagens din칙micas (VERS츾O FINAL E ROBUSTA)
    function showDynamicMessage(message, level) {
        
        // 1. Tenta encontrar o container que o 'base.html' cria
        let messagesContainer = document.querySelector('.messages');

        // 2. Se o 'base.html' n칚o criou (por n칚o ter msg do Django), N칍S CRIAMOS.
        if (!messagesContainer) {
            messagesContainer = document.createElement('ul');
            messagesContainer.className = 'messages'; 
            // Insere no topo do body, logo ap칩s o <header>
            const header = document.querySelector('header');
            if (header) {
                header.parentNode.insertBefore(messagesContainer, header.nextSibling);
            } else {
                document.body.prepend(messagesContainer); // Fallback
            }
        }

        // 3. Cria e adiciona a mensagem
        const messageLi = document.createElement('li');
        messageLi.className = level; // 'success' ou 'error'
        messageLi.textContent = message;
        messagesContainer.appendChild(messageLi);
        
        // 4. Define o tempo para remover
        setTimeout(() => {
            messageLi.style.opacity = '0';
            setTimeout(() => messageLi.remove(), 500);
        }, 5000);
    }

    // --- SUBMISS츾O DO FORMUL츼RIO ---
  statusForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const leituraId = modalLivroIdInput.value;
        const novoStatus = novoStatusSelect.value;
        const dataFinalizacao = document.getElementById('dataFinalizacao').value;
        // Certifique-se que a URL est치 correta para a view que altera o status
        const url = `/app/clube/{{ clube.id }}/admin/alterar-status-leitura/${leituraId}/`;

        let bodyData = { status: novoStatus };
        if (novoStatus === 'FINALIZADO') {
            // Valida칞칚o simples de data no front-end (opcional, mas recomendada)
            if (!dataFinalizacao) {
                showDynamicMessage('{% trans "Por favor, informe a data de finaliza칞칚o." %}', 'error');
                return; // Impede o envio se a data for obrigat칩ria e n칚o preenchida
            }
            bodyData.data_finalizacao = dataFinalizacao;
        }

        // Desabilitar bot칚o para evitar cliques m칰ltiplos (opcional)
        const submitButton = statusForm.querySelector('button[type="submit"]');
        if (submitButton) submitButton.disabled = true;

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(bodyData)
          });

          // Primeiro, verifica se a resposta HTTP indica um erro grave (ex: 403, 404, 500)
          if (!response.ok) {
              // Tenta ler a mensagem de erro do JSON, se houver
              let errorMessage = '{% trans "Ocorreu um erro no servidor." %}';
              try {
                  const errorData = await response.json();
                  errorMessage = errorData.message || errorMessage;
              } catch (jsonError) {
                  // Se n칚o conseguir ler o JSON, usa o status text
                  errorMessage = response.statusText || errorMessage;
              }
              throw new Error(errorMessage); // Joga o erro para o catch
          }

          // Se a resposta HTTP foi OK (2xx), processa o JSON
          const data = await response.json();
          showDynamicMessage(data.message, data.level); // Mostra a mensagem (success ou error l칩gico)

          // --- PONTO CHAVE DA CORRE칂츾O ---
          // Verifica se a opera칞칚o no backend foi realmente bem-sucedida
          if (data.success) {
            modalOverlay.style.display = 'none'; // Fecha o modal
            // Recarrega a p치gina ap칩s a mensagem ser exibida
            setTimeout(() => location.reload(), 1500); // Aumentei um pouco o tempo
          }
          // Se data.success for false, a mensagem de erro j치 foi exibida,
          // o modal permanece aberto para o usu치rio corrigir.

        } catch (error) {
          console.error('Erro na requisi칞칚o ou processamento:', error);
          // Mostra a mensagem de erro capturada (do throw new Error ou erro de rede)
          showDynamicMessage(error.message || '{% trans "Ocorreu um erro de rede. Tente novamente." %}', 'error');
        } finally {
            // Reabilita o bot칚o, independentemente do resultado
            if (submitButton) submitButton.disabled = false;
        }
      });
  });
</script>
{% endblock %}
