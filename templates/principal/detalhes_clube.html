{% extends 'principal/base.html' %}
{% load static %}
{% load i18n %}

{% block styles %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'principal/clube_detalhe.css' %}">
  <script src="{% static 'principal/js/clube_detalhe.js' %}"></script>
{% endblock %}

{% block content %}
 <form method="get" action="{% url 'principal:pagina_de_busca' %}" class="search-bar-container">
    <input class="search-bar-input" type="text" name="q" placeholder="{% trans 'Buscar livros, clubes...' %}" value="{{ search_query|default:'' }}">
    <button class="search-bar-button" type="submit">
      <i class="fas fa-search"></i>
    </button>
  </form>

  <div class="main-container">
    <div class="club-info section">
      {% if clube.capa_clube %}
        <img src="{{ clube.capa_clube.url }}" alt="{{ clube.nome }}" class="club-main-image">
      {% elif clube.capa_recomendada %}
        <img src="{% static clube.capa_recomendada %}" alt="{{ clube.nome }}" class="club-main-image">
      {% else %}
        <img src="{% static 'img/imgideal.png' %}" alt="{% trans 'Capa Padr√£o' %}" class="club-main-image">
      {% endif %}
      <div class="club-description-text">
        <h2>{{ clube.nome }}</h2>
        <p>{{ clube.descricao }}</p>
        <div class="club-meta">
            
            {% with creation_date=clube.data_criacao|date:"F Y" %}
                {% blocktrans %}Criado por <strong>{{ fundador_nome }}</strong> em {{ creation_date }}{% endblocktrans %}
            {% endwith %}
        </div>
      </div>

      <div class="club-actions">
        {% if is_membro %}
          
          <form method="post" action="{% url 'principal:sair_clube' clube.id %}">
            {% csrf_token %}
            <button type="submit" class="action-button sair-clube-button">{% trans "Sair do Clube" %}</button>
          </form>

        {% elif membro and membro.cargo == CargoChoices.PENDENTE %}
          <p class="feedback-text"><em>{% trans "Sua solicita√ß√£o est√° pendente de aprova√ß√£o." %}</em></p>

        {% elif membro and membro.cargo == CargoChoices.BANIDO %}
          <p class="feedback-text text-danger"><em>{% trans "Voc√™ foi banido deste clube." %}</em></p>

        {% elif membro and membro.deleted %}
          
          {% if clube.privacidade == PrivacidadeChoices.PUBLICO %}
            <form method="post" action="{% url 'principal:entrar_clube' clube.id %}">
              {% csrf_token %}
              <button type="submit" class="action-button entrar-clube-button">{% trans "Entrar no Clube" %}</button>
            </form>
          {% else %}
            <form method="post" action="{% url 'principal:solicitar_entrada_privado' clube.id %}">
              {% csrf_token %}
              <button type="submit" class="action-button entrar-clube-button">{% trans "Solicitar Entrada" %}</button>
            </form>
          {% endif %}

        {% else %}
          
          {% if clube.privacidade == PrivacidadeChoices.PUBLICO %}
            <form method="post" action="{% url 'principal:entrar_clube' clube.id %}">
              {% csrf_token %}
              <button type="submit" class="action-button entrar-clube-button">{% trans "Entrar no Clube" %}</button>
            </form>
          {% else %}
            <form method="post" action="{% url 'principal:solicitar_entrada_privado' clube.id %}">
              {% csrf_token %}
              <button type="submit" class="action-button entrar-clube-button">{% trans "Solicitar Entrada" %}</button>
            </form>
          {% endif %}
        {% endif %}
      </div>

    </div>

    {% if cargo_usuario_atual == CargoChoices.ADMIN %}
    <div class="admin-section section card-style">
        <h4>{% trans "Painel do Administrador do Clube" %}</h4>
        <div class="admin-actions">
            <a href="{% url 'principal:editar_clube' clube.id %}" class="action-button admin-button">{% trans "Editar Informa√ß√µes do Clube" %}</a>
            <a href="{% url 'principal:adicionar_livro_estante_clube' clube.id %}" class="action-button admin-button">{% trans "Adicionar Livro √† Estante" %}</a>
            <a href="{% url 'principal:definir_leitura_atual_clube' clube.id %}" class="action-button admin-button">{% trans "Definir Leitura Atual" %}</a>
            <a href="{% url 'principal:criar_votacao_clube' clube.id %}" class="action-button admin-button">{% trans "Criar Nova Vota√ß√£o" %}</a>
            <a href="{% url 'principal:criar_reuniao' clube.id %}" class="action-button admin-button">{% trans "Agendar Reuni√£o" %}</a>
            <a href="{% url 'principal:gerenciar_membros' clube.id %}" class="action-button admin-button">{% trans "Gerenciar Membros" %}</a>
          </div>
    </div>
    {% endif %}

{% if leitura_do_momento_obj %}
  <div class="featured-book section card-style">
    <h3 class="section-title">üìñ {% trans "Livro do Momento" %}</h3>
    <div class="book-card">
      <img src="{% if leitura_do_momento_obj.livro.capa %}{{ leitura_do_momento_obj.livro.capa.url }}{% else %}{% static 'img/default_book_cover.png' %}{% endif %}" alt="{{ leitura_do_momento_obj.livro.nome }}" class="book-cover">
      <div class="book-info">
        <h4 class="book-title">{{ leitura_do_momento_obj.livro.nome }}</h4>
        <p><strong>{% trans "Autor:" %}</strong> {{ leitura_do_momento_obj.livro.autor }}</p>
        <p><strong>{% trans "P√°ginas:" %}</strong> {{ leitura_do_momento_obj.livro.paginas }}</p>
      
        {% if is_membro and not estante_pessoal_obj %}
          <form method="post" action="{% url 'principal:iniciar_leitura' clube_id=clube.id livro_id=leitura_do_momento_obj.livro.id %}" style="margin-top: 15px;">
              {% csrf_token %}
              <button type="submit" class="btpadrao">{% trans "Iniciar Leitura" %}</button>
          </form>
        {% endif %}
        

      </div>
    </div>
  </div>
{% endif %}

{% if votacao_ativa %}
      <div class="voting-section section card-style">
        <div class="section-header">
       
        <h3>{% blocktrans %}Vota√ß√£o para Pr√≥ximo Livro <small>(encerra em {{ data_fim_votacao_formatada }})</small>{% endblocktrans %}</h3>
        
        {% if cargo_usuario_atual == CargoChoices.ADMIN %}
            <div class="header-actions">
                <a href="{% url 'principal:editar_votacao' clube_id=clube.id votacao_id=votacao_ativa.id %}" class="visit-button">{% trans "Editar" %}</a>
                <form action="{% url 'principal:fechar_votacao' clube.id votacao_ativa.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="visit-button" onclick="return confirm('{% trans 'Tem certeza que deseja fechar esta vota√ß√£o?' %}')">{% trans "Fechar" %}</button>
                </form>
            </div>
        {% endif %}
    </div>
        <form method="post" action="{% url 'principal:registrar_voto' clube_id=clube.id votacao_id=votacao_ativa.id %}">
          {% csrf_token %}
          {% for opcao in opcoes_votacao_com_votos %}
            <div class="book-option">
              <div class="book-row">
                <img src="{% if opcao.livro.capa %}{{ opcao.livro.capa.url }}{% else %}{% static 'img/default_book_cover.png' %}{% endif %}" alt="{{ opcao.livro.nome }}" class="book-option-image">
                <div class="book-option-details">
                  <strong class="book-option-title">{{ opcao.livro.nome }}</strong> <small class="book-option-author">{% trans "por" %} {{ opcao.livro.autor }}</small>
                  <div class="progress" title="{{ opcao.percentual }}% {% trans 'dos votos' %}">
                    <div class="progressbar" style="width: {{ opcao.percentual }}%;">{{ opcao.percentual }}%</div>
                  </div>
                  <small class="vote-count">{{ opcao.votos }} {% trans "voto(s) de" %} {{ total_votos_na_votacao }}</small>
                  {% if is_membro and not usuario_ja_votou %}<span class="vote-radio"><input type="radio" name="livro_votado" value="{{ opcao.livro.id }}" id="livro_{{opcao.livro.id}}"><label for="livro_{{opcao.livro.id}}">{% trans "Votar neste" %}</label></span>{% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
          {% if is_membro and not usuario_ja_votou and opcoes_votacao_com_votos %}<button type="submit" class="action-button vote-button">{% trans "Confirmar Voto" %}</button>
          {% elif is_membro and usuario_ja_votou %}<p class="feedback-text"><em>{% trans "Voc√™ j√° votou nesta vota√ß√£o." %}</em></p>
          {% elif not is_membro and votacao_ativa %}<p class="feedback-text"><em>{% trans "Voc√™ precisa ser membro para votar." %}</em></p>
          {% elif not opcoes_votacao_com_votos and votacao_ativa %}<p class="feedback-text"><em>{% trans "Nenhuma op√ß√£o de livro nesta vota√ß√£o ainda." %}</em></p>
          {% endif %}
        </form>
      </div>
    {% endif %}

    {% if not leitura_do_momento_obj and not votacao_ativa and cargo_usuario_atual == CargoChoices.ADMIN %}
      <div class="section suggestion-box card-style">
          <p>{% trans "O clube n√£o est√° lendo nenhum livro e n√£o h√° vota√ß√µes ativas." %}</p>
      </div>
    {% endif %}

    <div class="members-section section card-style">
      <h3>{% trans "Membros" %} ({{ contagem_membros_ativos }})</h3>
      <ul class="member-list">
        {% for membro_cm in membros_do_clube %}
          <li class="member-item">
            <img src="{{ default_avatar_url }}" alt="{{ membro_cm.usuario.nome }}" class="member-avatar">
            <div class="member-info">
              <span class="member-name {% if membro_cm.cargo == CargoChoices.ADMIN %}leader{% elif membro_cm.cargo == CargoChoices.MODERADOR %}co-leader{% endif %}">
                {{ membro_cm.usuario.nome }}
                {% if membro_cm.cargo == CargoChoices.ADMIN %}({% trans "Admin" %}){% elif membro_cm.cargo == CargoChoices.MODERADOR %}({% trans "Mod" %}){% endif %}
              </span>
              <div class="member-details">{% trans "Entrou:" %} {{ membro_cm.data_inscricao|date:"d/m/Y" }}</div>
            </div>
          </li>
        {% empty %}
          <li>{% trans "Este clube ainda n√£o tem membros." %}</li>
        {% endfor %}
      </ul>
    </div>

    <!-- <div class="shelf-section section card-style">
      <h3>{% trans "Livros J√° Lidos Pelo Clube" %}</h3>
      {% if leituras_finalizadas %}
        <ul class="shelf-list">
          {% for leitura in leituras_finalizadas %}
            <li class="shelf-item">
              <img src="{% if leitura.livro.capa %}{{ leitura.livro.capa.url }}{% else %}{% static 'img/default_book_cover.png' %}{% endif %}" alt="{{ leitura.livro.nome }}" class="shelf-book-cover">
              <div class="shelf-item-info">
                <strong>{{ leitura.livro.nome }}</strong>
                {% with final_date=leitura.data_finalizacao|date:"d/m/Y"|default:"N/D" rating=leitura.nota_media_clube|default:"N/A" %}
                    <span>{% blocktrans %}Finalizado em: {{ final_date }} | Avalia√ß√£o: {{ rating }}/5{% endblocktrans %}</span>
                {% endwith %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>{% trans "Nenhum livro finalizado pelo clube ainda." %}</p>
      {% endif %}
    </div>
  </div> -->

 {% if estante_pessoal_obj %}
<div class="card-container">
  <h2 class="card-title">{% trans "PROGRESSO DE LEITURA" %}</h2>
  <hr />
  <div class="card">
    <img src="{% if estante_pessoal_obj.livro.capa %}{{ estante_pessoal_obj.livro.capa.url }}{% else %}{% static 'img/default_book_cover.png' %}{% endif %}" alt="{{ estante_pessoal_obj.livro.nome }}" class="capa-progresso">
    <div class="content">
      <h3 class="title">{{ estante_pessoal_obj.livro.nome }}</h3>
      <p class="club">{{ estante_pessoal_obj.livro.autor }}</p>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar" style="width: {{ progresso_percentual }}%;"></div>
      </div>
      <div class="progress-text" id="progressText">
          {{ progresso_percentual }}% {% trans "conclu√≠do" %}
      </div>
      
     
      <div class="controls">
        <form method="post" action="{% url 'principal:atualizar_progresso' estante_pessoal_obj.id %}">
            {% csrf_token %}
            <label for="progressInput">{% trans "P√°ginas lidas:" %}</label>
            <input type="number" id="progressInput" name="paginas_lidas" min="0" max="{{ estante_pessoal_obj.livro.paginas|default:'' }}" value="{{ estante_pessoal_obj.progresso_paginas|default:0 }}">
            <button class="btpadrao" type="submit">{% trans "Atualizar" %}</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

 

  <div class="card-container">
    <h2 class="card-title">{% trans "VISITAR A ESTANTE DO CLUBE" %}</h2>
    <hr />
    <div class="card">
      <div class="content">
        <p>{% trans "Explore os livros mais desejados e odiados. Clique abaixo para visitar a estante e conhecer um pouco os gostos do nosso clube." %}</p>
        <div class="controls">
          <a href="{% url 'principal:estante' clube.id %}">
            <button class="visit-button">{% trans "Visitar Estante" %}</button>
          </a>
        </div>
      </div>
    </div>
  </div>


  <div class="card-container">
        <h3>üóìÔ∏è {% trans "Pr√≥ximas Reuni√µes" %}</h3>
        {% if reunioes_agendadas %}
            <ul class="meeting-list">
            {% for reuniao in reunioes_agendadas %}
                <li class="meeting-item">
                    <div class="meeting-date">
                        <span class="month">{{ reuniao.data_horario|date:"M" }}</span>
                        <span class="day">{{ reuniao.data_horario|date:"d" }}</span>
                    </div>
                    <div class="meeting-info">
                        <strong>{{ reuniao.titulo }}</strong>
                        <small>{% trans "√†s" %} {{ reuniao.data_horario|date:"H:i" }}</small>
                        {% if reuniao.leitura_associada %}<p>{% trans "Sobre o livro:" %} {{ reuniao.leitura_associada.livro.nome }}</p>{% endif %}
                        {% if reuniao.meta_tipo and reuniao.meta_quantidade %}<p class="meeting-goal">üéØ {% trans "Meta:" %} {% trans "Ler at√©" %} {{ reuniao.get_meta_tipo_display }} {{ reuniao.meta_quantidade }}</p>{% endif %}
                        <p>{{ reuniao.descricao|default:"" }}</p>
                        {% if reuniao.tipo == 'REMOTO' and reuniao.link_reuniao %}<a href="{{ reuniao.link_reuniao }}" target="_blank">{% trans "Link da Reuni√£o" %}</a>
                        {% elif reuniao.tipo == 'PRESENCIAL' and reuniao.endereco %}<span>üìç {{ reuniao.endereco }}</span>{% endif %}
                    </div>
                    {% if cargo_usuario_atual == CargoChoices.ADMIN %}
                        <a href="{% url 'principal:editar_reuniao' clube.id reuniao.id %}" class="edit-link small">{% trans "Editar" %}</a>
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "Nenhuma reuni√£o agendada." %}</p>
        {% endif %}
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- L√ìGICA 1: Anima√ß√£o das barras de progresso da vota√ß√£o ---
    const animateVotingBars = () => {
        const progressBars = document.querySelectorAll('.voting-section .progress-bar');
        progressBars.forEach(bar => {
            const finalWidth = bar.style.width;
            if (finalWidth) {
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = finalWidth;
                }, 300);
            }
        });
    };

    
    const handleReadingProgressUpdate = () => {
        const updateBtn = document.getElementById('updateProgressBtn');
        if (!updateBtn) return; // Se o bot√£o n√£o existir na p√°gina, n√£o faz nada

        updateBtn.addEventListener('click', () => {
            const input = document.getElementById('progressInput');
            const paginasLidas = input.value;
            const estanteId = "{{ estante_pessoal_obj.id }}"; // Django injeta o ID aqui
            const url = `/app/estante_pessoal/${estanteId}/atualizar_progresso/`;
            
            updateBtn.disabled = true;
            updateBtn.textContent = "{% trans 'Salvando...' %}";

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `paginas_lidas=${paginasLidas}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    const formatoTraduzido = progressText.getAttribute('data-translation-format');
                    
                    progressBar.style.width = data.percentual + '%';
                    progressText.textContent = formatoTraduzido.replace('{value}', data.percentual);
                    input.value = data.paginas_lidas;
                } else {
                    alert('{% trans "Erro ao atualizar o progresso." %}');
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                updateBtn.disabled = false;
                updateBtn.textContent = "{% trans 'Atualizar' %}";
            });
        });
    };

    
    animateVotingBars();
    handleReadingProgressUpdate();

});
</script>
{% endblock %}