{% extends 'principal/base.html' %}
{% load static %}
{% load i18n %}

{% block styles %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'principal/clube_detalhe.css' %}">
  <script src="{% static 'principal/js/clube_detalhe.js' %}"></script>
{% endblock %}

{% block content %}
  <form method="get" action="{% url 'principal:pagina_de_busca' %}" class="search-bar-container details-page-search">
    <input class="search-bar-input" type="text" name="q" placeholder="{% trans 'Buscar em Anúbis...' %}" value="{{ query|default_if_none:'' }}">
    <button class="search-bar-button" type="submit"><i class="fas fa-search"></i></button>
  </form>

  <div class="main-container">
    <div class="club-info section">
        {% if clube.capa_clube %}<img src="{{ clube.capa_clube.url }}" alt="{{ clube.nome }}" class="club-main-image">
        {% elif clube.capa_recomendada %}<img src="{% static clube.capa_recomendada %}" alt="{{ clube.nome }}" class="club-main-image">
        {% else %}<img src="{% static 'img/imgideal.png' %}" alt="{% trans 'Capa Padrão' %}" class="club-main-image">{% endif %}
        <div class="club-description-text">
            <h2>{{ clube.nome }}</h2>
            <p>{{ clube.descricao }}</p>
            <div class="club-meta">
                {# --- CORREÇÃO APLICADA AQUI --- #}
                {% blocktrans %}Criado por <strong>{{ fundador_nome }}</strong> em {{ data_criacao_formatada }}{% endblocktrans %}
            </div>
        </div>
        <div class="club-actions">
            {% if is_membro %}
            <form method="post" action="{% url 'principal:sair_clube' clube.id %}">
                {% csrf_token %}<button type="submit" class="action-button sair-clube-button">{% trans "Sair do Clube" %}</button>
            </form>
            {% elif clube.privacidade == PrivacidadeChoices.PUBLICO %}
            <form method="post" action="{% url 'principal:entrar_clube' clube.id %}">
                {% csrf_token %}<button type="submit" class="action-button entrar-clube-button">{% trans "Entrar no Clube" %}</button>
            </form>
            {% else %}<p class="feedback-text"><em>{% trans "Este clube é privado." %}</em></p>{% endif %}
        </div>
    </div>

    {% if votacao_ativa %}
      <div class="voting-section section card-style">
        {# --- CORREÇÃO APLICADA AQUI --- #}
        <h3>{% blocktrans %}Votação para Próximo Livro <small>(encerra em {{ data_fim_votacao_formatada }})</small>{% endblocktrans %}</h3>
        <form method="post" action="{% url 'principal:registrar_voto' clube_id=clube.id votacao_id=votacao_ativa.id %}">
          {% csrf_token %}
          {% for opcao in opcoes_votacao_com_votos %}
            <div class="book-option">
              <div class="book-row">
                <img src="{% if opcao.livro.capa %}{{ opcao.livro.capa.url }}{% else %}{% static 'img/default_book_cover.png' %}{% endif %}" alt="{{ opcao.livro.nome }}" class="book-option-image">
                <div class="book-option-details">
                  <strong class="book-option-title">{{ opcao.livro.nome }}</strong> <small class="book-option-author">{% trans "por" %} {{ opcao.livro.autor }}</small>
                  <div class="progress" title="{{ opcao.percentual }}% {% trans 'dos votos' %}">
                    <div class="progress-bar" style="width: {{ opcao.percentual }}%;">{{ opcao.percentual }}%</div>
                  </div>
                  <small class="vote-count">{{ opcao.votos }} {% trans "voto(s) de" %} {{ total_votos_na_votacao }}</small>
                  {% if is_membro and not usuario_ja_votou %}
                    <span class="vote-radio">
                        <input type="radio" name="livro_votado" value="{{ opcao.livro.id }}" id="livro_{{opcao.livro.id}}">
                        <label for="livro_{{opcao.livro.id}}">{% trans "Votar neste" %}</label>
                    </span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
          {% if is_membro and not usuario_ja_votou and opcoes_votacao_com_votos %}<button type="submit" class="action-button vote-button">{% trans "Confirmar Voto" %}</button>
          {% elif is_membro and usuario_ja_votou %}<p class="feedback-text"><em>{% trans "Você já votou nesta votação." %}</em></p>
          {% elif not is_membro and votacao_ativa %}<p class="feedback-text"><em>{% trans "Você precisa ser membro para votar." %}</em></p>
          {% elif not opcoes_votacao_com_votos and votacao_ativa %}<p class="feedback-text"><em>{% trans "Nenhuma opção de livro nesta votação ainda." %}</em></p>
          {% endif %}
        </form>
      </div>
    {% endif %}

    </div>
{% endblock %}